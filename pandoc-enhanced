#!/bin/bash

# Pandoc Enhanced - å¢å¼ºç‰ˆ pandoc è½¬æ¢å™¨
# æ”¯æŒä¸­æ–‡ã€emojiã€å¤šç§è¾“å‡ºæ ¼å¼å’Œè‡ªå®šä¹‰æ¨¡æ¿

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
if [ -L "$0" ]; then
    # å¦‚æœæ˜¯è½¯é“¾æ¥ï¼Œè·å–çœŸå®è·¯å¾„
    SCRIPT_DIR="$( cd "$( dirname "$(readlink "$0")" )" &> /dev/null && pwd )"
else
    SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
fi

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
Pandoc Enhanced - å¢å¼ºç‰ˆ pandoc è½¬æ¢å™¨

ç”¨æ³•: pandoc-enhanced <input_file> [options]

æ”¯æŒæ ¼å¼:
    è¾“å…¥: markdown, org, rst, docx, epub, html ç­‰
    è¾“å‡º: pdf, docx, html, epub, pptx ç­‰

å‚æ•°:
    <input_file>        è¦è½¬æ¢çš„æ–‡ä»¶è·¯å¾„
    
åŸºæœ¬é€‰é¡¹:
    -f, --format <fmt>  è¾“å‡ºæ ¼å¼ (pdf|docx|html|epub|pptx) (é»˜è®¤: pdf)
    -o, --output <dir>  è¾“å‡ºç›®å½• (é»˜è®¤: ~/Documents)
    -t, --title <title> æ–‡æ¡£æ ‡é¢˜ (é»˜è®¤: ä½¿ç”¨æ–‡ä»¶å)
    -s, --subtitle <subtitle> å‰¯æ ‡é¢˜ (é»˜è®¤: V0.1)
    -a, --author <author> ä½œè€… (é»˜è®¤: æ‰‹å·¥å·)
    
é«˜çº§é€‰é¡¹:
    --template <name>   æŒ‡å®šæ¨¡æ¿ (eisvogel|default|custom)
    --theme <name>      PDF ä¸»é¢˜è‰² (blue|red|green|purple æˆ– #åå…­è¿›åˆ¶é¢œè‰²) (é»˜è®¤: #B55F3F)
    --toc               ç”Ÿæˆç›®å½• (é»˜è®¤å¯ç”¨)
    --no-toc            ä¸ç”Ÿæˆç›®å½•
    --emoji             å¯ç”¨ emoji æ”¯æŒ (é»˜è®¤å¯ç”¨)
    --no-emoji          ç¦ç”¨ emoji æ”¯æŒ
    --lang <lang>       æ–‡æ¡£è¯­è¨€ (zh-CN|en-US|ja-JP) (é»˜è®¤: zh-CN)
    --qrcode-url <url>  ç”Ÿæˆ URL çš„ QR ç å¹¶æ·»åŠ åˆ°æ–‡æ¡£
    --qrcode-bg <bg>    QR ç èƒŒæ™¯è‰² (transparent|theme|#åå…­è¿›åˆ¶) (é»˜è®¤: transparent)
    --qrcode-fg <fg>    QR ç å‰æ™¯è‰² (#åå…­è¿›åˆ¶) (è‡ªåŠ¨é€‰æ‹©)
    
å…¶ä»–é€‰é¡¹:
    -h, --help          æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯
    -v, --version       æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
    --debug             å¯ç”¨è°ƒè¯•æ¨¡å¼

ç¤ºä¾‹:
    # åŸºæœ¬ PDF è½¬æ¢
    pandoc-enhanced test.md
    
    # è½¬æ¢ä¸º Word æ–‡æ¡£
    pandoc-enhanced test.md -f docx
    
    # è‡ªå®šä¹‰è¾“å‡ºå’Œæ ·å¼
    pandoc-enhanced test.md -o ~/Desktop -t "æŠ€æœ¯æ–‡æ¡£" --theme blue
    
    # ç”Ÿæˆå¸¦ QR ç çš„ PDFï¼ˆé€æ˜èƒŒæ™¯ï¼‰
    pandoc-enhanced test.md --qrcode-url "https://github.com"
    
    # QR ç ä½¿ç”¨æ–‡æ¡£ä¸»é¢˜è‰²ä½œä¸ºèƒŒæ™¯
    pandoc-enhanced test.md --qrcode-url "https://github.com" --qrcode-bg theme
    
    # è‡ªå®šä¹‰ QR ç é¢œè‰²
    pandoc-enhanced test.md --qrcode-url "https://github.com" --qrcode-bg "#FF0000" --qrcode-fg "#FFFFFF"
    
    # è½¬æ¢ä¸º HTML æ¼”ç¤ºæ–‡ç¨¿
    pandoc-enhanced test.md -f html --template slides
    
    # è‹±æ–‡æ–‡æ¡£è½¬æ¢
    pandoc-enhanced readme.md --lang en-US --author "John Doe"

é…ç½®æ–‡ä»¶:
    ~/.config/pandoc-enhanced/config.yaml - å…¨å±€é…ç½®
    .pandoc-enhanced.yaml - é¡¹ç›®é…ç½®
EOF
}

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
show_version() {
    echo "Pandoc Enhanced v1.0.0"
    echo "Enhanced pandoc converter with Chinese and emoji support"
}

# é»˜è®¤å‚æ•°
OUTPUT_DIR="$HOME/Documents"
FORMAT="pdf"
SUBTITLE="V0.1"
AUTHOR="æ‰‹å·¥å·"
TITLE=""
TEMPLATE="eisvogel"
THEME="#B55F3F"
TOC=true
EMOJI=true
LANG="zh-CN"
DEBUG=false
INPUT_FILE=""
QRCODE_URL=""
QRCODE_BG="transparent"
QRCODE_FG=""

# ä¸»é¢˜è‰²é…ç½®å‡½æ•°
get_theme_color() {
    # æ£€æŸ¥æ˜¯å¦æ˜¯ç›´æ¥çš„åå…­è¿›åˆ¶é¢œè‰²å€¼
    if [[ $1 =~ ^#?[0-9A-Fa-f]{6}$ ]]; then
        # ç§»é™¤å¯èƒ½çš„ # å‰ç¼€ï¼Œè¿”å›çº¯åå…­è¿›åˆ¶å€¼
        echo "${1#\#}"
    else
        # ä½¿ç”¨é¢„å®šä¹‰çš„ä¸»é¢˜
        case $1 in
            "blue") echo "1E88E5" ;;
            "red") echo "E53935" ;;
            "green") echo "43A047" ;;
            "purple") echo "5D1EB1" ;;
            "orange") echo "FB8C00" ;;
            "teal") echo "00ACC1" ;;
            *) echo "B55F3F" ;;  # é»˜è®¤ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„é¢œè‰²
        esac
    fi
}

# è·å– QR ç çš„å®é™…ä¸»é¢˜è‰²ï¼ˆåº”ç”¨ eisvogel/pagecolor çš„é¢œè‰²å˜æ¢ï¼‰
get_qrcode_theme_color() {
    local theme_color="$1"
    
    # eisvogel çš„ pagecolor ä¼šå¯¹é¢œè‰²è¿›è¡Œå˜æ¢
    # ç»è¿‡åˆ†æï¼Œå˜æ¢ç³»æ•°ä¸º: R*0.895, G*0.937, B*0.937
    # ä½¿ç”¨ Python è¿›è¡Œç²¾ç¡®è®¡ç®—
    local adjusted_color=$(python3 -c "
import sys
hex_color = '$theme_color'.lstrip('#')
r = int(hex_color[0:2], 16)
g = int(hex_color[2:4], 16)
b = int(hex_color[4:6], 16)

# åº”ç”¨ eisvogel/pagecolor çš„å˜æ¢ç³»æ•°
# ä½¿ç”¨ round è€Œä¸æ˜¯ int ä»¥è·å¾—æ›´å‡†ç¡®çš„ç»“æœ
r_new = round(r * 0.895)
g_new = round(g * 0.937)
b_new = round(b * 0.937)

print('{:02X}{:02X}{:02X}'.format(r_new, g_new, b_new))
" 2>/dev/null)
    
    if [ -n "$adjusted_color" ]; then
        echo "$adjusted_color"
    else
        # å¦‚æœ Python è®¡ç®—å¤±è´¥ï¼Œè¿”å›åŸè‰²
        echo "$theme_color"
    fi
}

# è§£æå‚æ•°
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            show_version
            exit 0
            ;;
        -f|--format)
            FORMAT="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        -t|--title)
            TITLE="$2"
            shift 2
            ;;
        -s|--subtitle)
            SUBTITLE="$2"
            shift 2
            ;;
        -a|--author)
            AUTHOR="$2"
            shift 2
            ;;
        --template)
            TEMPLATE="$2"
            shift 2
            ;;
        --theme)
            THEME="$2"
            shift 2
            ;;
        --toc)
            TOC=true
            shift
            ;;
        --no-toc)
            TOC=false
            shift
            ;;
        --emoji)
            EMOJI=true
            shift
            ;;
        --no-emoji)
            EMOJI=false
            shift
            ;;
        --lang)
            LANG="$2"
            shift 2
            ;;
        --qrcode-url)
            QRCODE_URL="$2"
            shift 2
            ;;
        --qrcode-bg)
            QRCODE_BG="$2"
            shift 2
            ;;
        --qrcode-fg)
            QRCODE_FG="$2"
            shift 2
            ;;
        --debug)
            DEBUG=true
            shift
            ;;
        -*)
            echo "æœªçŸ¥é€‰é¡¹: $1"
            show_help
            exit 1
            ;;
        *)
            if [ -z "$INPUT_FILE" ]; then
                INPUT_FILE="$1"
            else
                echo "é”™è¯¯: åªèƒ½æŒ‡å®šä¸€ä¸ªè¾“å…¥æ–‡ä»¶"
                show_help
                exit 1
            fi
            shift
            ;;
    esac
done

# æ£€æŸ¥å¿…éœ€å‚æ•°
if [ -z "$INPUT_FILE" ]; then
    echo "é”™è¯¯: å¿…é¡»æŒ‡å®šè¾“å…¥æ–‡ä»¶"
    show_help
    exit 1
fi

# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if [ ! -f "$INPUT_FILE" ]; then
    echo "é”™è¯¯: æ–‡ä»¶ $INPUT_FILE ä¸å­˜åœ¨"
    exit 1
fi

# è°ƒè¯•ä¿¡æ¯
if [ "$DEBUG" = true ]; then
    echo "ğŸ› è°ƒè¯•æ¨¡å¼å·²å¯ç”¨"
    echo "è¾“å…¥æ–‡ä»¶: $INPUT_FILE"
    echo "è¾“å‡ºæ ¼å¼: $FORMAT"
    echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
    echo "æ¨¡æ¿: $TEMPLATE"
    echo "ä¸»é¢˜: $THEME"
    echo "Emoji: $EMOJI"
    echo "ç›®å½•: $TOC"
    echo "è¯­è¨€: $LANG"
    [ -n "$QRCODE_URL" ] && echo "QRç  URL: $QRCODE_URL"
    [ -n "$QRCODE_URL" ] && echo "QRç èƒŒæ™¯: $QRCODE_BG"
fi

# è·å–ç»å¯¹è·¯å¾„
INPUT_FILE=$(realpath "$INPUT_FILE")
BASENAME=$(basename "$INPUT_FILE" | sed 's/\.[^.]*$//')

# å¦‚æœæ²¡æœ‰æŒ‡å®šæ ‡é¢˜ï¼Œä½¿ç”¨æ–‡ä»¶å
if [ -z "$TITLE" ]; then
    TITLE="$BASENAME"
fi

# ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
mkdir -p "$OUTPUT_DIR"
OUTPUT_DIR=$(realpath "$OUTPUT_DIR")

# ä¸´æ—¶æ–‡ä»¶
TEMP_DIR=$(mktemp -d)
HEADER_FILE="$TEMP_DIR/enhanced-header.tex"

# æ¸…ç†å‡½æ•°
cleanup() {
    if [ "$DEBUG" = false ]; then
        rm -rf "$TEMP_DIR"
    else
        echo "ğŸ› ä¸´æ—¶æ–‡ä»¶ä¿ç•™åœ¨: $TEMP_DIR"
    fi
}
trap cleanup EXIT

# è·å–ä¸»é¢˜è‰²
THEME_COLOR=$(get_theme_color "$THEME")

# ç”Ÿæˆå¢å¼ºå¤´æ–‡ä»¶
echo "ğŸ”§ å‡†å¤‡è½¬æ¢ç¯å¢ƒ..."

if [ "$EMOJI" = true ] && [ "$FORMAT" = "pdf" ]; then
    echo "ğŸ” æ‰«æ emoji å­—ç¬¦..."
    python3 "$SCRIPT_DIR/generate_emoji_header.py" "$INPUT_FILE" "$HEADER_FILE"
    if [ $? -ne 0 ]; then
        echo "âŒ ç”Ÿæˆ emoji å¤´æ–‡ä»¶å¤±è´¥"
        exit 1
    fi
else
    # åˆ›å»ºåŸºæœ¬å¤´æ–‡ä»¶
    cat > "$HEADER_FILE" << EOF
\\usepackage{fontspec}
\\usepackage{xeCJK}
EOF
fi

# ç”Ÿæˆ QR ç ï¼ˆå¦‚æœæä¾›äº† URLï¼‰
QRCODE_PATH=""
if [ -n "$QRCODE_URL" ] && [ "$FORMAT" = "pdf" ]; then
    echo "ğŸ”— ç”Ÿæˆ QR ç : $QRCODE_URL"
    
    # å‡†å¤‡èƒŒæ™¯è‰²å’Œå‰æ™¯è‰²å‚æ•°
    BG_COLOR=""
    FG_COLOR="000000"  # é»˜è®¤é»‘è‰²å‰æ™¯
    
    if [ "$QRCODE_BG" = "transparent" ]; then
        BG_COLOR="transparent"
        # å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šå‰æ™¯è‰²ï¼Œé€æ˜èƒŒæ™¯ç”¨é»‘è‰²å‰æ™¯
        [ -z "$QRCODE_FG" ] && FG_COLOR="000000" || FG_COLOR="${QRCODE_FG#\#}"
    elif [ "$QRCODE_BG" = "theme" ]; then
        # ä½¿ç”¨ä¸»é¢˜è‰²ä½œä¸ºèƒŒæ™¯ï¼ˆè°ƒæ•´ä¸ºå®é™…æ¸²æŸ“çš„é¢œè‰²ï¼‰
        BG_COLOR=$(get_qrcode_theme_color "$THEME_COLOR")
        # å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šå‰æ™¯è‰²ï¼Œä¸»é¢˜è‰²èƒŒæ™¯ç”¨ç™½è‰²å‰æ™¯
        [ -z "$QRCODE_FG" ] && FG_COLOR="FFFFFF" || FG_COLOR="${QRCODE_FG#\#}"
    elif [ -n "$QRCODE_BG" ]; then
        # ä½¿ç”¨æŒ‡å®šçš„é¢œè‰²
        BG_COLOR="${QRCODE_BG#\#}"
        # å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šå‰æ™¯è‰²ï¼Œæ·±è‰²èƒŒæ™¯ç”¨ç™½è‰²å‰æ™¯
        [ -z "$QRCODE_FG" ] && FG_COLOR="FFFFFF" || FG_COLOR="${QRCODE_FG#\#}"
    fi
    
    # å¦‚æœç”¨æˆ·æŒ‡å®šäº†å‰æ™¯è‰²ä½†æ²¡æœ‰æŒ‡å®šèƒŒæ™¯è‰²
    if [ -n "$QRCODE_FG" ] && [ -z "$BG_COLOR" ]; then
        BG_COLOR="transparent"
        FG_COLOR="${QRCODE_FG#\#}"
    fi
    
    # è°ƒç”¨ Python è„šæœ¬ç”Ÿæˆ QR ç 
    QRCODE_OUTPUT=$(python3 "$SCRIPT_DIR/generate_qrcode.py" "$QRCODE_URL" "$TEMP_DIR" 200 "$BG_COLOR" "$FG_COLOR" 2>&1)
    if [ $? -eq 0 ]; then
        # ä»è¾“å‡ºä¸­æå– QR ç è·¯å¾„
        QRCODE_PATH=$(echo "$QRCODE_OUTPUT" | grep "QRCODE_PATH:" | cut -d':' -f2-)
        if [ -n "$QRCODE_PATH" ]; then
            echo "âœ… QR ç å·²ç”Ÿæˆ: $QRCODE_PATH"
        fi
    else
        echo "âŒ ç”Ÿæˆ QR ç å¤±è´¥"
        echo "$QRCODE_OUTPUT"
        exit 1
    fi
fi

# æ£€æŸ¥å¿…è¦çš„å·¥å…·
if ! command -v pandoc &> /dev/null; then
    echo "âŒ æœªæ‰¾åˆ° pandocï¼Œè¯·å…ˆå®‰è£…"
    exit 1
fi

# æ„å»º pandoc å‘½ä»¤
PANDOC_CMD="pandoc \"$INPUT_FILE\""
PANDOC_CMD="$PANDOC_CMD -o \"$OUTPUT_DIR/${BASENAME}.${FORMAT}\""
PANDOC_CMD="$PANDOC_CMD -M title=\"$TITLE\""
PANDOC_CMD="$PANDOC_CMD -M subtitle=\"$SUBTITLE\""
PANDOC_CMD="$PANDOC_CMD -M date=\"$(date '+%Y-%m-%d')\""
PANDOC_CMD="$PANDOC_CMD -M author=\"$AUTHOR\""
PANDOC_CMD="$PANDOC_CMD -M lang=\"$LANG\""

# æ ¹æ®è¾“å‡ºæ ¼å¼è®¾ç½®ç‰¹å®šå‚æ•°
case $FORMAT in
    pdf)
        if ! command -v xelatex &> /dev/null; then
            echo "âŒ æœªæ‰¾åˆ° xelatexï¼Œè¯·å…ˆå®‰è£… LaTeX"
            exit 1
        fi
        
        PANDOC_CMD="$PANDOC_CMD -f markdown+wikilinks_title_after_pipe"
        PANDOC_CMD="$PANDOC_CMD --template $TEMPLATE"
        PANDOC_CMD="$PANDOC_CMD -t pdf"
        PANDOC_CMD="$PANDOC_CMD --pdf-engine=xelatex"
        PANDOC_CMD="$PANDOC_CMD -V mainfont=\"Songti SC\""
        PANDOC_CMD="$PANDOC_CMD -V CJKmainfont=\"Songti SC\""
        PANDOC_CMD="$PANDOC_CMD -V monofont=\"Noto Sans Mono CJK SC\""
        PANDOC_CMD="$PANDOC_CMD -V sansfont=\"Noto Sans CJK SC\""
        
        if [ "$EMOJI" = true ]; then
            PANDOC_CMD="$PANDOC_CMD -H \"$HEADER_FILE\""
        fi
        
        PANDOC_CMD="$PANDOC_CMD -M titlepage=true"
        PANDOC_CMD="$PANDOC_CMD -M titlepage-color=\"$THEME_COLOR\""
        PANDOC_CMD="$PANDOC_CMD -M titlepage-text-color=\"FFFFFF\""
        PANDOC_CMD="$PANDOC_CMD -M titlepage-rule-color=\"FFE600\""
        PANDOC_CMD="$PANDOC_CMD -M titlepage-rule-height=2"
        PANDOC_CMD="$PANDOC_CMD -M logo-width=\"6cm\""
        
        # å¦‚æœæœ‰ QR ç ï¼Œæ·»åŠ ä¸º titlepage-logo
        if [ -n "$QRCODE_PATH" ]; then
            PANDOC_CMD="$PANDOC_CMD -M titlepage-logo=\"$QRCODE_PATH\""
            PANDOC_CMD="$PANDOC_CMD -M qrcode-url=\"$QRCODE_URL\""
        fi
        
        if [ "$TOC" = true ]; then
            PANDOC_CMD="$PANDOC_CMD -M toc=true"
        fi
        
        PANDOC_CMD="$PANDOC_CMD -V documentclass=report -V book -V classoption=openany"
        ;;
        
    docx)
        if [ "$TOC" = true ]; then
            PANDOC_CMD="$PANDOC_CMD --toc"
        fi
        ;;
        
    html)
        PANDOC_CMD="$PANDOC_CMD -s --self-contained"
        if [ "$TOC" = true ]; then
            PANDOC_CMD="$PANDOC_CMD --toc"
        fi
        ;;
        
    epub)
        if [ "$TOC" = true ]; then
            PANDOC_CMD="$PANDOC_CMD --toc"
        fi
        ;;
        
    pptx)
        PANDOC_CMD="$PANDOC_CMD -t pptx"
        ;;
        
    *)
        echo "âŒ ä¸æ”¯æŒçš„è¾“å‡ºæ ¼å¼: $FORMAT"
        echo "æ”¯æŒçš„æ ¼å¼: pdf, docx, html, epub, pptx"
        exit 1
        ;;
esac

# æ‰§è¡Œè½¬æ¢
echo "ğŸ“ è½¬æ¢ä¸º $FORMAT æ ¼å¼..."

if [ "$DEBUG" = true ]; then
    echo "ğŸ› æ‰§è¡Œå‘½ä»¤: $PANDOC_CMD"
    eval $PANDOC_CMD
else
    eval $PANDOC_CMD 2>/dev/null
fi

if [ $? -eq 0 ]; then
    echo "âœ… è½¬æ¢æˆåŠŸ: $OUTPUT_DIR/${BASENAME}.${FORMAT}"
    
    # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
    FILE_SIZE=$(du -h "$OUTPUT_DIR/${BASENAME}.${FORMAT}" | cut -f1)
    echo "ğŸ“Š æ–‡ä»¶å¤§å°: $FILE_SIZE"
else
    echo "âŒ è½¬æ¢å¤±è´¥"
    if [ "$DEBUG" = false ]; then
        echo "ğŸ’¡ ä½¿ç”¨ --debug é€‰é¡¹æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"
    fi
    exit 1
fi